<!--/////////////////////////////////////////////////-->
<!--//PAGE FOR THE EXTENSIONS BACKEND IN LNBITS//////-->
<!--/////////////////////////////////////////////////-->

{% extends "base.html" %} {% from "macros.jinja" import window_vars with context
%} {% block scripts %} {{ window_vars(user) }}
<script src="{{ static_url_for('nostriotdashboard/static', path='js/nostr-tools.bundle.js') }}"></script>
<script src="{{ static_url_for('nostriotdashboard/static', path='js/index.js') }}"></script>
{% endblock %} {% block page %}

<div id="vue">
  <q-layout view="hHh lpR fFf">
    <q-page-container>
      <q-page class="q-pa-md">
        
        <!-- Header -->
        <div class="row q-mb-lg">
          <div class="col">
            <h4 class="q-mt-none q-mb-md">Nostr IoT Dashboard</h4>
            <p class="text-caption">Interact with Nostr IoT devices using DVM protocol</p>
          </div>
          <div v-if="isAuthenticated" class="col-auto">
            <q-btn 
              color="negative" 
              label="Logout" 
              @click="logout"
              icon="logout"
              outline
              size="sm"
            />
          </div>
        </div>

        <!-- Authentication Section -->
        <q-card v-if="!isAuthenticated" class="q-mb-lg">
          <q-card-section>
            <h6 class="q-mt-none">Connect with Nostr</h6>
            <p class="text-caption">Choose your authentication method</p>
            <div class=" flex row">
            <div class="q-mr-md">
              <q-btn 
                color="primary" 
                label="Log in with browser extension" 
                @click="connectNostr"
                :loading="connecting && authMethod === 'extension'"
                icon="extension"
              />
            </div>
            <div>
              <q-btn 
                color="secondary" 
                label="Log in with private key" 
                @click="showNsecDialog"
                :loading="connecting && authMethod === 'nsec'"
                icon="vpn_key"
              />
              </div>
              </div>
          </q-card-section>
        </q-card>

        <!-- Relay Configuration -->
        <q-card v-if="isAuthenticated" class="q-mb-lg">
          <q-card-section>
            <div class="row items-center q-mb-md">
              <h6 class="q-mt-none q-mb-none col">Relay Configuration</h6>
              <q-btn 
                size="sm" 
                color="primary" 
                icon="add" 
                @click="addRelay" 
                round 
                dense
              />
            </div>
            <div class="row q-gutter-sm">
              <q-chip 
                v-for="relay in relays" 
                :key="relay"
                :label="relay"
                removable
                @remove="removeRelay(relay)"
                color="primary"
                text-color="white"
              />
            </div>
          </q-card-section>
        </q-card>

        <!-- IoT Devices -->
        <div v-if="isAuthenticated">
          <div class="row items-center q-mb-md">
            <h6 class="q-mt-none q-mb-none col">
              <span v-if="showExploreView">Explore IoT Service Providers</span>
              <span v-else>Your IoT Service Providers</span>
            </h6>
            <div class="col-auto q-gutter-sm flex">
              <p>
              <q-btn 
                size="sm" 
                color="secondary" 
                icon="explore" 
                :label="exploreButtonLabel"
                @click="toggleExploreView"
                outline
              />
              </p>
              <p>
              <q-btn 
                v-if="!showExploreView"
                size="sm" 
                color="positive" 
                icon="refresh" 
                @click="refreshDevices"
                :loading="loadingDevices"
                round 
                dense
              />
              </p>
            </div>
          </div>

          <!-- Loading State -->
          <div v-if="loadingDevices && !showExploreView" class="text-center q-pa-lg">
            <q-spinner size="xl" color="primary" />
            <p class="q-mt-md">Discovering IoT devices...</p>
          </div>

          <!-- No Devices Found -->
          <q-card v-else-if="iotDevices.length === 0 && !showExploreView" class="text-center q-pa-lg">
            <q-card-section>
              <q-icon name="device_hub" size="xl" color="grey-5" />
              <h6 class="q-mt-md q-mb-sm">No IoT devices found</h6>
              <p class="text-caption">Follow some Nostr accounts that provide IoT services</p>
            </q-card-section>
          </q-card>

          <!-- Device List -->
          <div v-else-if="!showExploreView" class="row q-gutter-md">
            <q-card 
              v-for="device in iotDevices" 
              :key="device.pubkey"
              class="col-12 col-md-6"
            >
              <q-card-section>
                <div class="text-h6">${device.name}</div>
                <p class="text-caption q-mb-md">${device.about}</p>
                
                <div class="q-gutter-xs">
                  <div v-for="capability in device.capabilities" :key="capability" class="full-width">
                    
                    <!-- Get methods (simple button) -->
                    <q-btn
                      v-if="!isSetMethod(capability)"
                      :label="getReadableCapability(capability)"
                      size="sm"
                      color="primary"
                      outline
                      @click="executeCapability(device, capability)"
                      :loading="isCapabilityLoading(device.pubkey, capability)"
                      class="full-width text-left"
                    >
                      <div class="column full-width">
                        <div 
                          v-if="getCapabilityResult(device.pubkey, capability)" 
                          class="text-caption text-grey-6 q-mt-xs"
                        >
                          ${getCapabilityResult(device.pubkey, capability)}
                        </div>
                      </div>
                    </q-btn>

                    <!-- Set methods (input + button) -->
                    <q-card v-else flat bordered class="q-pa-sm">
                      <div class="text-weight-medium q-mb-sm">${getReadableCapability(capability)}</div>
                      <div class="row q-gutter-sm items-center">
                        <q-input
                          v-model="setMethodInputs[device.pubkey + ':' + capability]"
                          dense
                          outlined
                          placeholder="Enter value"
                          class="col"
                        />
                        <q-btn
                          label="Set"
                          size="sm"
                          color="primary"
                          @click="executeSetCapability(device, capability)"
                          :loading="isCapabilityLoading(device.pubkey, capability)"
                          :disable="!setMethodInputs[device.pubkey + ':' + capability]"
                        />
                      </div>
                      <div 
                        v-if="getCapabilityResult(device.pubkey, capability)" 
                        class="text-caption text-grey-6 q-mt-sm"
                      >
                        ${getCapabilityResult(device.pubkey, capability)}
                      </div>
                    </q-card>

                  </div>
                </div>
              </q-card-section>
            </q-card>
          </div>

          <!-- Explore Service Providers View -->
          <div v-if="showExploreView">
            
            <!-- Search and Filter Section -->
            <q-card class="q-mb-lg">
              <q-card-section>
                <div class="row items-center q-gutter-md">
                  <div class="col">
                    <q-input
                      v-model="searchTerm"
                      placeholder="Search service providers..."
                      outlined
                      dense
                      clearable
                    >
                      <template v-slot:prepend>
                        <q-icon name="search" />
                      </template>
                    </q-input>
                  </div>
                  <div class="col-auto">
                    <q-btn 
                      color="primary"
                      icon="refresh"
                      label="Refresh"
                      @click="discoverServiceProviders"
                      :loading="loadingProviders"
                      outline
                    />
                  </div>
                </div>
              </q-card-section>
            </q-card>

            <!-- Loading State -->
            <div v-if="loadingProviders" class="text-center q-pa-lg">
              <q-spinner size="xl" color="primary" />
              <p class="q-mt-md">Discovering IoT service providers...</p>
            </div>

            <!-- No Providers Found -->
            <div v-else-if="filteredProviders.length === 0 && !loadingProviders" class="text-center q-pa-lg">
              <q-icon name="search_off" size="4rem" color="grey-5" />
              <p class="q-mt-md text-grey-6">
                <span v-if="searchTerm">No service providers found matching "${searchTerm}"</span>
                <span v-else>No IoT service providers found</span>
              </p>
              <q-btn 
                v-if="!searchTerm"
                color="primary" 
                label="Refresh Search" 
                @click="discoverServiceProviders"
                outline
              />
            </div>

            <!-- Providers Grid -->
            <div v-else class="row q-gutter-md">
              <div 
                v-for="provider in filteredProviders" 
                :key="provider.pubkey"
                class="col-12 col-sm-6 col-md-4"
              >
                <q-card class="full-height">
                  <q-card-section>
                    <div class="row items-start justify-between q-mb-sm">
                      <div class="col">
                        <h6 class="q-ma-none text-weight-bold">${provider.name}</h6>
                        <p class="text-caption text-grey-6 q-mb-sm">${formatPubkey(provider.pubkey)}</p>
                      </div>
                      <div class="col-auto">
                        <div v-if="isFollowing(provider.pubkey)">
                        <q-btn
                          color="negative"
                          icon="person_remove"
                          label="Unfollow"
                          size="sm"
                          @click="unfollowProvider(provider)"
                          :loading="followingStates[provider.pubkey]"
                          outline
                          dense
                        />
                        </div>
                        <div v-else>
                          <q-btn
                            v-if="!isFollowing(provider.pubkey)"
                            color="primary"
                            icon="person_add"
                            label="Follow"
                            size="sm"
                            @click="followProvider(provider)"
                            outline
                            dense
                          />
                        </div>
                        
                      </div>
                    </div>
                    
                    <p class="text-body2 q-mb-md">${provider.about}</p>
                    
                    <div v-if="provider.capabilities.length > 0">
                      <p class="text-caption text-weight-medium q-mb-sm">Capabilities:</p>
                      <div class="row q-gutter-xs">
                        <q-chip
                          v-for="capability in provider.capabilities.slice(0, 6)"
                          :key="capability"
                          :label="getReadableCapability(capability)"
                          size="sm"
                          color="grey-3"
                          text-color="black"
                        />
                        <q-chip
                          v-if="provider.capabilities.length > 6"
                          :label="getMoreCapabilitiesLabel(provider.capabilities)"
                          size="sm"
                          color="grey-3"
                          text-color="black"
                        />
                      </div>
                    </div>
                    
                    <div class="text-caption text-grey-6 q-mt-sm">
                      Last updated: ${formatDate(provider.created_at)}
                    </div>
                  </q-card-section>
                </q-card>
              </div>
            </div>
            
            <!-- Results Summary -->
            <div v-if="!loadingProviders && serviceProviders.length > 0" class="text-center q-mt-lg">
              <p class="text-caption text-grey-6">
                Showing ${filteredProviders.length} of ${serviceProviders.length} service providers
                <span v-if="searchTerm">(filtered by "${searchTerm}")</span>
              </p>
            </div>
          </div>
        </div>

        <!-- Invoice Modal -->
        <q-dialog v-model="invoiceDialog.show">
          <q-card style="min-width: 400px">
            <q-card-section>
              <div class="text-h6">Payment Required</div>
              <p class="text-caption">Amount: ${invoiceDialog.amount} sats</p>
            </q-card-section>
            
            <!-- Payment Options -->
            <q-card-section class="q-pt-none">
              <!-- Wallet Selection -->
              <div class="q-mb-md">
                <q-select
                  v-model="selectedWallet"
                  :options="g.user.wallets"
                  option-label="name"
                  option-value="id"
                  label="Select wallet"
                  outlined
                  dense
                  emit-value
                  map-options
                  class="q-mb-sm"
                />
                
                
              </div>
              <q-btn
                color="primary"
                icon="account_balance_wallet"
                label="Pay with selected wallet"
                @click="payWithLNbits"
                :loading="invoiceDialog.paymentLoading"
                :disable="invoiceDialog.paymentLoading || !selectedWallet"
                class="full-width"
                size="md"
              />
            </q-card-section>

            <!-- Divider -->
              <div class="row items-center q-mb-md">
                <div class="col">
                  <q-separator />
                </div>
                <div class="col-auto q-px-md flex flex-column items-center">
                  <p class="text-caption text-grey-6 q-mb-none">or scan QR code with a lightning wallet</p>
                </div>
                <div class="col">
                  <q-separator />
                </div>
              </div>
            
            <!-- QR Code Section -->
            <q-card-section class="text-center q-pt-none">
              <lnbits-qrcode
                :value="'lightning:' + invoiceDialog.bolt11"
                :href="'lightning:' + invoiceDialog.bolt11"
                class="rounded-borders"
              ></lnbits-qrcode>
            </q-card-section>
            
            <q-card-actions align="right">
              <q-btn flat label="Close" @click="invoiceDialog.show = false" />
            </q-card-actions>
          </q-card>
        </q-dialog>

        <!-- Add Relay Modal -->
        <q-dialog v-model="relayDialog.show">
          <q-card style="min-width: 300px">
            <q-card-section>
              <div class="text-h6">Add Relay</div>
            </q-card-section>
            <q-card-section>
              <q-input 
                v-model="relayDialog.url" 
                label="Relay URL"
                placeholder="wss://relay.example.com"
              />
            </q-card-section>
            <q-card-actions align="right">
              <q-btn flat label="Cancel" @click="relayDialog.show = false" />
              <q-btn color="primary" label="Add" @click="confirmAddRelay" />
            </q-card-actions>
          </q-card>
        </q-dialog>

        <!-- Private Key (nsec) Modal -->
        <q-dialog v-model="nsecDialog.show">
          <q-card style="min-width: 400px">
            <q-card-section>
              <div class="text-h6">Enter Private Key</div>
              <p class="text-caption">Enter your Nostr private key (nsec format)</p>
            </q-card-section>
            <q-card-section>
              <q-input 
                v-model="nsecDialog.privateKey" 
                label="Private Key (nsec...)"
                placeholder="nsec1..."
                type="password"
                outlined
              />
              <div class="text-caption text-warning q-mt-sm">
                 Your private key is only stored locally and never sent to any server
              </div>
            </q-card-section>
            <q-card-actions align="right">
              <div  class="q-mr-sm">
              <q-btn flat label="Cancel" @click="nsecDialog.show = false" />
              </div>
              <div>
              <q-btn 
                color="primary" 
                label="Connect" 
                @click="connectWithNsec"
                :loading="connecting && authMethod === 'nsec'"
                :disable="!nsecDialog.privateKey"
              />
              </div>
            </q-card-actions>
          </q-card>
        </q-dialog>

      </q-page>
    </q-page-container>
  </q-layout>
</div>

{% endblock %}
